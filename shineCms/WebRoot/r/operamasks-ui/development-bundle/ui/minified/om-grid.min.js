(function(a){a.omGrid={lang:{loadingMsg:"正在加载数据，请稍候...",emptyMsg:"没有数据",errorMsg:"取数出错",pageText:"第{index}页，共{totalPage}页",pageStat:"共{total}条数据，显示{from}-{to}条"}};a.widget("om.omGrid",{options:{height:462,width:"100%",colModel:false,autoFit:false,showIndex:true,dataSource:false,method:"GET",loadingMsg:a.omGrid.lang.loadingMsg,emptyMsg:a.omGrid.lang.emptyMsg,errorMsg:a.omGrid.lang.errorMsg,preProcess:false,limit:15,pageText:a.omGrid.lang.pageText,pageStat:a.omGrid.lang.pageStat,rowClasses:["oddRow","evenRow"],singleSelect:true,onRowSelect:function(c,b){},onRowDeselect:function(c,b){},onRowClick:function(c,b){},onRowDblClick:function(c,b){},onPageChange:function(c,b){},onSuccess:function(d,b,c){},onError:function(b,d,c){},onRefresh:function(c,b){}},_create:function(){var c=this.options,d=this.element.show().attr({cellPadding:0,cellSpacing:0,border:0}).empty().append("<tbody></tbody>");d.wrap('<div class="om-grid om-widget om-widget-content"><div class="bDiv"></div></div>').closest(".om-grid").width(c.width).height(c.height);var b=c.colModel;if(!a.isArray(b)){return}this.tbody=this.element.children().eq(0);this._buildTableHead();this._buildPagingToolBar();this._buildLoadMask();this._bindSelectAndClickEnvent();this._bindScrollEnvent();this._makeColsResizable()},_init:function(){if(!a.isArray(this.options.colModel)){return}var e=this.element,g=this.options,d=e.closest(".om-grid"),f=d.children(".hDiv").outerHeight(),b=d.children(".pDiv").outerHeight()||0,c=d.children(".bDiv");c.height(d.height()-f-b);this.pageData={nowPage:1,totalPages:1};this._populate()},_setOption:function(d,e){var c=this.options,b=c[d];c[d]=e;switch(d){case"colModel":break;case"dataSource":case"limit":break;case"autoFit":break;case"height":break;case"width":break;case"pageText":break;case"fillEmptyRows":break;case"wrap":break;case"singleSelect":break;case"rowClasses":break;case"paged":break;default:c[d]=e}},_buildTableHead:function(){var o=this.options,e=this.element,b=e.closest(".om-grid"),p=o.colModel,w=0,q=0,h=0,l=-1;thead=a("<thead></thead");tr=a("<tr></tr>").appendTo(thead);if(o.showIndex){var d=a("<th></th").attr({axis:"indexCol",align:"center"}).addClass("indexCol").append(a('<div class="indexheader" style="text-align:center;width:25px;"></div'));tr.append(d);q=25}if(!o.singleSelect){var d=a("<th></th").attr({axis:"checkboxCol",align:"center"}).addClass("checkboxCol").append(a('<div class="checkboxheader" style="text-align:center;width:17px;"><span class="checkbox"/></div'));tr.append(d);h=17}for(var t=0,u=p.length;t<u;t++){var m=p[t],n=m.width||60,r=m.align||"center";if(n=="autoExpand"){n=0;l=t}var s=a("<div></div").html(m.header).css({"text-align":r,width:n});m.wrap&&s.addClass("wrap");var g=a("<th></th").attr("axis","col"+t).addClass("col"+t).append(s);if(m.name){g.attr("abbr",m.name)}if(m.align){g.attr("align",m.align)}w+=n;tr.append(g)}e.prepend(thead);var k=a('<div class="hDiv om-state-default"></div>').append('<div class="hDivBox"><table cellPadding="0" cellSpacing="0"></table></div>');e.parent().before(k);a("table",k).append(thead);if(l!=-1){var v=b.width()-20,j=v-thead.width();toBeExpandedTh=tr.find('th[axis="col'+l+'"] div');if(j<=0){toBeExpandedTh.css("width",60)}else{toBeExpandedTh.css("width",j)}}else{if(o.autoFit){var v=b.width()-20,j=v-thead.width(),c=1+j/w,x=tr.find('th[axis^="col"] div');for(var t=0,u=p.length;t<u;t++){var f=x.eq(t);f.css("width",parseInt(f.width()*c))}}}this.thead=thead;thead=null},_buildPagingToolBar:function(){var f=this.options;if(f.limit<=0){return}var c=this,d=this.element,b=a('<div class="pDiv om-state-default"><div class="pDiv2"><div class="pGroup"><div class="pFirst pButton om-icon"><span class="om-icon-seek-start"></span></div><div class="pPrev pButton om-icon"><span class="om-icon-seek-prev"></span></div></div><div class="btnseparator"></div><div class="pGroup"><span class="pControl"></span></div><div class="btnseparator"></div><div class="pGroup"><div class="pNext pButton om-icon"><span class="om-icon-seek-next"></span></div><div class="pLast pButton om-icon"><span class="om-icon-seek-end"></span></div></div><div class="btnseparator"></div><div class="pGroup"><div class="pReload pButton om-icon"><span class="om-icon-refresh"></span></div></div><div class="btnseparator"></div><div class="pGroup"><span class="pPageStat"></span></div></div></div>');var e=f.pageText.replace(/{totalPage}/,"<span>1</span>").replace(/{index}/,'<input type="text" size="4" value="1" />');a(".pControl",b).html(e);d.parent().after(b);a(".pReload",b).click(function(){c._populate()});a(".pFirst",b).click(function(){c._changePage("first")});a(".pPrev",b).click(function(){c._changePage("prev")});a(".pNext",b).click(function(){c._changePage("next")});a(".pLast",b).click(function(){c._changePage("last")});a(".pControl input",b).keydown(function(g){if(g.keyCode==13){c._changePage("input")}});a(".pButton",b).hover(function(){a(this).addClass("om-state-hover")},function(){a(this).removeClass("om-state-hover")});this.pager=b},_buildLoadMask:function(){var b=this,f=this.options,e=this.element,c=e.closest(".om-grid"),d=a('<div class="gBlock"><div align="center" class="gBlock-valignMiddle" ><div class="loadingImg" style="display:block"/></div></div>').css({width:c.width(),height:c.height()}).mousedown(function(g){return false}).hide();c.append(d);this.loadMask=d},_changePage:function(c){if(this.loading){return true}var e=this.element,h=this.options,b=e.closest(".om-grid"),d=this.pageData,g=d.nowPage,i=d.totalPages,f=g;switch(c){case"first":f=1;break;case"prev":if(g>1){f=g-1}break;case"next":if(g<i){f=g+1}break;case"last":f=i;break;case"input":var j=parseInt(a(".pControl input",e.closest(".om-grid")).val());if(isNaN(j)){j=g}if(j<1){j=1}else{if(j>i){j=i}}a(".pControl input",this.pDiv).val(j);f=j;break;default:if(/\d/.test(c)){var j=parseInt(c);if(isNaN(j)){j=1}if(j<1){j=1}else{if(j>i){j=i}}a(".pControl input",e.closest(".om-grid")).val(j);f=j}}if(f==g){return false}if(h.onPageChange(c,f)===false){return}d.nowPage=f;a("th.checkboxCol span.checkbox",b).removeClass("selected");this._populate()},_populate:function(){var k=this,f=this.element,b=f.closest(".om-grid"),j=this.options,e=a(".pPageStat",b);if(!j.dataSource){a(".pPageStat",b).html(j.emptygMsg);return false}if(this.loading){return true}var d=this.pageData,h=d.nowPage||1,c=a(".gBlock",b);this.loading=true;e.html(j.loadingMsg);c.show();if(a.browser.opera){a(b).css("visibility","hidden")}var i=(j.limit<=0)?100000000:j.limit;var g=[{name:"start",value:i*(h-1)},{name:"limit",value:i},{name:"_time_stamp_",value:new Date().getTime()}];a.ajax({type:j.method,url:j.dataSource,data:g,dataType:"json",success:function(m,o,l){var n=j.onSuccess;if(typeof(n)=="function"){n(m,o,l)}k._addData(m);j.onRefresh(h,m.rows);c.hide();k.loading=false},error:function(m,p,o){e.html(j.errorMsg).css("color","red");try{var l=j.onError;if(typeof(l)=="function"){l(m,p,o)}}catch(n){}finally{c.hide();k.loading=false;return false}}})},_addData:function(g){var h=this.options,f=this.element,e=f.closest(".om-grid"),b=a(".pPageStat",e),d=h.preProcess,c=this.pageData;d&&(g=d(g));c.data=g;c.totalPages=Math.ceil(g.total/h.limit);this._buildPager();this._renderDatas()},_buildPager:function(){var i=this.options;if(i.limit<=0){return}var e=this.element,g=this.pager,b=a(".pControl",g),d=this.pageData,f=d.nowPage,j=d.totalPages,h=d.data,l=i.limit*(f-1)+1,k=l-1+h.rows.length,c="";if(h.total===0){c=i.emptyMsg}else{c=i.pageStat.replace(/{from}/,l).replace(/{to}/,k).replace(/{total}/,h.total)}a("input",b).val(f);a("span",b).html(j);a(".pPageStat",g).html(c)},_renderDatas:function(l,m){var n=this,f=this.element,i=this.options,c=f.closest(".om-grid"),j=a(".hDiv thead tr:first th",c),o=this.pageData.data.rows,k=i.colModel,g=i.rowClasses,h=a("tbody",f).empty(),b=(typeof g==="function"),e=this.pageData,d=(e.nowPage-1)*i.limit;a.each(o,function(p,s){var r=b?g(p,s):g[p%g.length];var q=a("<tr></tr>").addClass(r);var t=n._buildRowCellValues(k,s,p);a(j).each(function(){var x=a(this).attr("axis"),w=false,v;if(x=="indexCol"){v=p+d+1}else{if(x=="checkboxCol"){v='<span class="checkbox"/>'}else{var u=x.substring(3);v=t[u];if(k[u].wrap){w=true}}}var y=a("<td></td>").attr({align:this.align,abbr:this.abbr}).addClass(x).append(a("<div></div>").html(v).addClass(w?"wrap":"").attr({align:this.align}).width(a("div",a(this)).width()));q.append(y)});h.append(q)})},_buildRowCellValues:function(j,d,h){var f=j.length,k=[];for(var e=0;e<f;e++){var g=j[e],l=d[g.name],b=g.renderer;if(typeof b==="function"){l=b(l,h)}k[e]=l}return k},_bindScrollEnvent:function(){var b=this.thead.closest(".hDiv");this.tbody.closest(".bDiv").scroll(function(){b.scrollLeft(a(this).scrollLeft())})},_bindSelectAndClickEnvent:function(){var b=this;if(!this.options.singleSelect){a("th.checkboxCol span.checkbox",this.thead).click(function(){var e=a(this),d=a("tr",this.tbody).size();if(e.hasClass("selected")){e.removeClass("selected");for(var c=0;c<d;c++){b._rowDeSelect(c)}}else{e.addClass("selected");for(var c=0;c<d;c++){b._rowSelect(c)}}});this.tbody.delegate("tr","click",function(){var d=a(this),c=d.index();if(d.hasClass("om-state-highlight")){b._rowDeSelect(c)}else{b._rowSelect(c)}b._refreshHeaderCheckBox();b.options.onRowClick(c,b._getRowData(c))});this.tbody.delegate("tr","dblclick",function(){var d=a(this),c=d.index();if(d.hasClass("om-state-highlight")){}else{b._rowSelect(c);b._refreshHeaderCheckBox()}b.options.onRowDblClick(c,b._getRowData(c))})}else{this.tbody.delegate("tr","click",function(){var e=a(this),c=e.index();if(e.hasClass("om-state-highlight")){}else{var d=a("tr.om-state-highlight",b.tbody).index();(d!=-1)&&b._rowDeSelect(d);b._rowSelect(c)}b.options.onRowClick(c,b._getRowData(c))});this.tbody.delegate("tr","dblclick",function(){var c=a(this).index();b.options.onRowDblClick(c,b._getRowData(c))})}},_getRowData:function(b){return this.pageData.data.rows[b]},_rowSelect:function(d){var e=this.element,g=this.options,c=a("tbody",e),f=a("tr:eq("+d+")",c),b=a("td.checkboxCol span.checkbox",f);f.addClass("om-state-highlight");b.addClass("selected");g.onRowSelect(d,this._getRowData(d))},_rowDeSelect:function(e){var c=this,f=this.element,h=this.options,d=a("tbody",f),g=a("tr:eq("+e+")",d),b=a("td.checkboxCol span.checkbox",g);g.removeClass("om-state-highlight");b.removeClass("selected");h.onRowDeselect(e,this._getRowData(e))},_refreshHeaderCheckBox:function(){var b=a("td.checkboxCol span.selected",this.tbody).size(),c=a("th.checkboxCol span.checkbox",this.thead);if(b<this.pageData.data.rows.length){c.removeClass("selected")}else{c.addClass("selected")}},_makeColsResizable:function(){var c=this,e=c.tbody.closest(".bDiv"),d=c.element.closest(".om-grid"),b=c.pager;a('th[axis^="col"] div',c.thead).resizable({handles:"e",containment:"document",minWidth:60,resize:function(i,j){var k=a(this),g=k.parent().attr("abbr"),h=a('td[abbr="'+g+'"] > div',c.tbody),f=c.thead.closest(".hDiv");k.width(j.size.width).height("");h.width(j.size.width).height("");e.height(d.height()-f.outerHeight()-b.outerHeight())}})},setData:function(b){this.options.dataSource=b;this.pageData={nowPage:1,totalPages:1};this._populate()},getData:function(){return this.pageData.data},refresh:function(){if(this.loading){return true}this.loading=true;var b=this.options;a(".pPageStat",this.pager).html(b.loadingMsg);this.loadMask.show();this._buildPager();this._renderDatas();b.onRefresh(this.pageData.nowPage||1,this.pageData.data.rows);this.loadMask.hide();this.loading=false},reload:function(b){if(this.loading){return true}if(typeof b!=="undefined"){b=parseInt(b)||1;if(b<0){b=1}if(b>this.pageData.totalPages){b=this.pageData.totalPages}this.pageData.nowPage=b}this._populate()},setSelections:function(c){var b=this;if(!a.isArray(c)){c=[c]}var d=this.getSelections();a(d).each(function(){b._rowDeSelect(this)});a(c).each(function(){b._rowSelect(this)})},getSelections:function(d){var e=this,c=a("tr.om-state-highlight",this.tbody),b=[];if(d){var f=e.pageData.data.rows;c.each(function(){b[b.length]=f[a(this).index()]})}else{c.each(function(){b[b.length]=a(this).index()})}return b}})})(jQuery);