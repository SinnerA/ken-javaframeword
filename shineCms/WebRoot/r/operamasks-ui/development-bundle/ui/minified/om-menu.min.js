(function(a){a.widget("om.omMenu",{options:{contextMenu:false,maxWidth:200,minWidth:100,dataSource:"local"},show:function(g){var c=this,d=c.options,i,h,e=c.element;if(d.contextMenu){i=g.pageY;h=g.pageX;g.preventDefault();g.stopPropagation();g.cancelBubble=true}else{var b=parseInt(a(g).css("borderBottomWidth").replace("px",""));var f=a(g).offset();i=f.top+a(g).height()+(b!="NaN"?b:0)+1;h=f.left+1}a(e).css({top:i,left:h}).show();a(e).children("ul.om-menu").show()},hide:function(){this._hide()},disableItem:function(e){var c=this,d=c.element;var b=d.find("#"+e);b.addClass("om-state-disabled");b.unbind("mouseenter.menuItem").unbind("mouseleave.menuItem").unbind("mousedown.menuItem")},enableItem:function(e){var c=this,d=c.element;var b=d.find("#"+e);b.removeClass("om-state-disabled");c._bindLiEvent(b)},_create:function(){var c=this.element,b=this.options;a(c).css({position:"absolute",minWidth:b.minWidth,maxWidth:b.maxWidth-10}).addClass("om-menu-container om-menu-content om-corner-all");if(a.browser.msie&&a.browser.version=="6.0"){a(c).css("width",b.minWidth+30)}},_init:function(){var c=this,d=c.options,f=c.element,e=d.dataSource;if(e){if(e!="local"){if(typeof e=="string"){c._ajaxLoad(f,e)}else{if(typeof e=="object"){f.append(c._appendNodes.apply(c,[e]));c._bindEvent()}}}else{var b=c.element.children("ul").addClass("om-menu");c._parseDomMenu(b);c._bindEvent()}}},_ajaxLoad:function(d,c){var b=this;a.ajax({url:c,method:"POST",dataType:"json",success:function(e){d.append(b._appendNodes.apply(b,[e]));b._bindEvent()}})},_appendNodes:function(h,d){var b=this,c=[];var f=(d==undefined)?"om-menu":"om-menu-content";var i=(d==undefined)?"block":"none";var e=(d==undefined)?"om-menu-icon":"om-menu-icon om-menu-icon-child";c.push('<ul class="'+f+' om-corner-all" style="display:'+i+';">');var g=[];a(h).each(function(k,l){if(l.children!=null){if(l.disabled===true||l.disabled=="true"){g.push('<li id="'+l.id+'" aria-haspopup="true"  class="om-state-disabled">')}else{g.push('<li id="'+l.id+'"  aria-haspopup="true">')}g.push('<a href="javascript:void(0)" class="om-corner-all om-menu-indicator">');l.icon?g.push('<img class="'+e+'" src="'+l.icon+'">'):null;l.icon?g.push("<span>"+l.label+"</span>"):g.push('<span style="margin-left:2em;">'+l.label+"</span>");g.push('<span class="ui-icon-span" role="popup"></span>');g.push("</a>");g.push(b._appendNodes(l.children,k++));g.push("</li>")}else{if(l.disabled===true||l.disabled=="true"){g.push('<li id="'+l.id+'"  class="om-state-disabled">')}else{g.push('<li id="'+l.id+'" >')}g.push('<a href="javascript:void(0)" class="om-corner-all om-menu-indicator">');l.icon?g.push('<img class="'+e+'" src="'+l.icon+'">'):null;l.icon?g.push("<span>"+l.label+"</span>"):g.push('<span style="margin-left:2em;">'+l.label+"</span>");g.push("</a>");g.push("</li>")}if(l.seperator=="true"||l.seperator==true){g.push('<li class="om-menu-sep-li"  ><span class="om-menu-item-sep">&nbsp;</span></li>')}var j=a(b.element).attr("id")+"_"+l.id;a(b.element).data(j,l)});c.push(g.join(""));c.push("</ul>");return c.join("")},_parseDomMenu:function(f){if(f.parent().attr("aria-haspopup")=="true"){f.addClass("om-menu-content om-corner-all").css("display","none")}var d=f.children();for(var e=0;e<d.length;e++){var b=a(d[e]),c=b.children("ul");if(c.length>0){b.attr("aria-haspopup","true");b.find("span[role='popup']").addClass("ui-icon-span");this._parseDomMenu(c)}b.find("a").addClass("om-corner-all om-menu-indicator");b.find("img").addClass("om-menu-icon")}},_showChildren:function(b){if(b&&b.length>0){var c=b.children("ul").eq(0);c.css({minWidth:this.options.minWidth,maxWidth:this.options.maxWidth,top:b.position().top});if(a.browser.msie&&a.browser.version=="6.0"){(b.parent().parent().hasClass("om-menu-container"))?c.css("left",0):c.css("left",b.width());c.css("width",this.options.minWidth)}else{c.css("left",b.width())}c.css("display","block");c.show()}},_hideChildren:function(b){b.children("ul").eq(0).hide()},_bindLiEvent:function(b){var c=this,e=c.element,d=c.options;a(b).bind("mouseenter.menuItem",function(){var f=a(this);f.addClass("om-menu-item-hover");if(f.attr("aria-haspopup")){setTimeout(function(){c._showChildren(f)},200)}}).bind("mouseleave.menuItem",function(){var f=a(this);f.removeClass("om-menu-item-hover");setTimeout(function(){f.children("ul").hide()},200)}).bind("mousedown.menuItem",function(g){var f=a(e).data(a(e).attr("id")+"_"+this.id);if(d.onSelect){d.onSelect(f);g.preventDefault();g.stopPropagation();g.cancelBubble=true}})},_bindEvent:function(){var b=this,g=b.element,e=b.options;var h=g.find("ul");var d=g.find("li");for(var f=0;f<d.length;f++){if(!a(d[f]).hasClass("om-state-disabled")){b._bindLiEvent(d[f])}}for(var c=0;c<h.length;c++){a(h[c]).bind("mouseleave.menuContainer",function(){var i=a(this);if(i.parent().attr("aria-haspopup")=="true"){i.hide()}})}a(document).bind("mousedown.omMenu",function(){b._hide()}).keyup(function(j){var i=j.keyCode;switch(i){case 40:b._selectNext();break;case 38:b._selectPrev();break;case 37:b._hideRight();break;case 39:b._showRight();break;case 13:if(g.css("display")=="block"){b._backfill(g)}break;case 27:b._hide();break;default:null}}).keydown(function(i){if(i.keyCode>=37&&i.keyCode<=40){i.preventDefault()}})},_hide:function(){var b=this,c=b.element;c.find("ul").css("display","none");c.find("li.om-menu-item-hover").each(function(d,e){a(e).removeClass("om-menu-item-hover")});c.hide()},_findNext:function(b){var c,e=b;while((c=b.next("li")).length!==0){if(!c.hasClass("om-menu-sep-li")&&!c.hasClass("om-state-disabled")){return c}b=c}var d=e.parent().find("li:first");while(d.length!==0&&d!=e){if(!d.hasClass("om-menu-sep-li")&&!d.hasClass("om-state-disabled")){return d}d=d.next("li")}},_findPrev:function(b){var d,e=b;while((d=b.prev("li")).length!==0){if(!d.hasClass("om-menu-sep-li")&&!d.hasClass("om-state-disabled")){return d}b=d}var c=e.parent().find("li:last");while(c.length!==0&&c!=e){if(!c.hasClass("om-menu-sep-li")&&!c.hasClass("om-state-disabled")){return c}c=c.prev("li")}},_selectNext:function(){var c=this,d=c.element,f;var b=d.find("li.om-menu-item-hover");var e=b.eq(b.length-1);if(b.length==0){f=d.find("li").eq(0);f.addClass("om-menu-item-hover")}else{f=c._findNext(e);if(f.length<=0){return}f.addClass("om-menu-item-hover");e.removeClass("om-menu-item-hover")}this._hideChildren(e);this._showChildren(f)},_selectPrev:function(){var c=this,d=c.element,f;var b=d.find("li.om-menu-item-hover");var e=b.eq(b.length-1);f=d.find("ul.om-menu > li");if(b.length==0){f.eq(f.length-1).addClass("om-menu-item-hover")}else{f=c._findPrev(e);if(f.length<=0){return}f.addClass("om-menu-item-hover");e.removeClass("om-menu-item-hover")}this._hideChildren(e);this._showChildren(f)},_hideRight:function(){var b=this,d=b.element;var c=d.find("li.om-menu-item-hover"),e=c.eq(c.length-1);e.removeClass("om-menu-item-hover");b._hideChildren(e)},_showRight:function(){var c=this,d=c.element,f;var e=d.find("li.om-menu-item-hover"),b=e.eq(e.length-1);if(b.attr("aria-haspopup")=="true"){f=b.children("ul").find("li").eq(0);f.addClass("om-menu-item-hover")}c._showChildren(f)},_backfill:function(b){var c=b.find("li.om-menu-item-hover");c.eq(c.length-1).mousedown()}})})(jQuery);